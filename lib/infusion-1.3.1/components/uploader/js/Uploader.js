var fluid_1_3=fluid_1_3||{};(function($,fluid){var fileOrFiles=function(that,numFiles){return(numFiles===1)?that.options.strings.progress.singleFile:that.options.strings.progress.pluralFiles};var enableElement=function(that,elm){elm.removeAttr("disabled");elm.removeClass(that.options.styles.dim)};var disableElement=function(that,elm){elm.attr("disabled","disabled");elm.addClass(that.options.styles.dim)};var showElement=function(that,elm){elm.removeClass(that.options.styles.hidden)};var hideElement=function(that,elm){elm.addClass(that.options.styles.hidden)};var setTotalProgressStyle=function(that,didError){didError=didError||false;var indicator=that.totalProgress.indicator;indicator.toggleClass(that.options.styles.totalProgress,!didError);indicator.toggleClass(that.options.styles.totalProgressError,didError)};var setStateEmpty=function(that){disableElement(that,that.locate("uploadButton"));if(that.queue.files.length===0){that.locate("browseButtonText").text(that.options.strings.buttons.browse);that.locate("browseButton").removeClass(that.options.styles.browseButton);showElement(that,that.locate("instructions"))}};var setStateDone=function(that){disableElement(that,that.locate("uploadButton"));enableElement(that,that.locate("browseButton"));that.strategy.local.enableBrowseButton();hideElement(that,that.locate("pauseButton"));showElement(that,that.locate("uploadButton"))};var setStateLoaded=function(that){that.locate("browseButtonText").text(that.options.strings.buttons.addMore);that.locate("browseButton").addClass(that.options.styles.browseButton);hideElement(that,that.locate("pauseButton"));showElement(that,that.locate("uploadButton"));enableElement(that,that.locate("uploadButton"));enableElement(that,that.locate("browseButton"));that.strategy.local.enableBrowseButton();hideElement(that,that.locate("instructions"));that.totalProgress.hide()};var setStateUploading=function(that){that.totalProgress.hide(false,false);setTotalProgressStyle(that);hideElement(that,that.locate("uploadButton"));disableElement(that,that.locate("browseButton"));that.strategy.local.disableBrowseButton();enableElement(that,that.locate("pauseButton"));showElement(that,that.locate("pauseButton"));that.locate(that.options.focusWithEvent.afterUploadStart).focus()};var renderUploadTotalMessage=function(that){var numReadyFiles=that.queue.getReadyFiles().length;var bytesReadyFiles=that.queue.sizeOfReadyFiles();var fileLabelStr=fileOrFiles(that,numReadyFiles);var totalStateStr=fluid.stringTemplate(that.options.strings.progress.toUploadLabel,{fileCount:numReadyFiles,fileLabel:fileLabelStr,totalBytes:fluid.uploader.formatFileSize(bytesReadyFiles)});that.locate("totalFileStatusText").html(totalStateStr)};var updateTotalProgress=function(that){var batch=that.queue.currentBatch;var totalPercent=fluid.uploader.derivePercent(batch.totalBytesUploaded,batch.totalBytes);var numFilesInBatch=batch.files.length;var fileLabelStr=fileOrFiles(that,numFilesInBatch);var totalProgressStr=fluid.stringTemplate(that.options.strings.progress.totalProgressLabel,{curFileN:batch.fileIdx,totalFilesN:numFilesInBatch,fileLabel:fileLabelStr,currBytes:fluid.uploader.formatFileSize(batch.totalBytesUploaded),totalBytes:fluid.uploader.formatFileSize(batch.totalBytes)});that.totalProgress.update(totalPercent,totalProgressStr)};var updateTotalAtCompletion=function(that){var numErroredFiles=that.queue.getErroredFiles().length;var numTotalFiles=that.queue.files.length;var fileLabelStr=fileOrFiles(that,numTotalFiles);var errorStr="";if(numErroredFiles>0){var errorLabelString=(numErroredFiles===1)?that.options.strings.progress.singleError:that.options.strings.progress.pluralErrors;setTotalProgressStyle(that,true);errorStr=fluid.stringTemplate(that.options.strings.progress.numberOfErrors,{errorsN:numErroredFiles,errorLabel:errorLabelString})}var totalProgressStr=fluid.stringTemplate(that.options.strings.progress.completedLabel,{curFileN:that.queue.getUploadedFiles().length,totalFilesN:numTotalFiles,errorString:errorStr,fileLabel:fileLabelStr,totalCurrBytes:fluid.uploader.formatFileSize(that.queue.sizeOfUploadedFiles())});that.totalProgress.update(100,totalProgressStr)};var updateQueueSummaryText=function(that){var fileQueueTable=that.locate("fileQueue");if(that.queue.files.length===0){fileQueueTable.attr("summary",that.options.strings.queue.emptyQueue)}else{var queueSummary=fluid.stringTemplate(that.options.strings.queue.queueSummary,{totalUploaded:that.queue.getUploadedFiles().length,totalInUploadQueue:that.queue.files.length-that.queue.getUploadedFiles().length});fileQueueTable.attr("summary",queueSummary)}};var bindDOMEvents=function(that){that.locate("uploadButton").click(function(){that.start()});that.locate("pauseButton").click(function(){that.stop()})};var updateStateAfterFileDialog=function(that){if(that.queue.getReadyFiles().length>0){setStateLoaded(that);renderUploadTotalMessage(that);that.locate(that.options.focusWithEvent.afterFileDialog).focus();updateQueueSummaryText(that)}};var updateStateAfterFileRemoval=function(that){if(that.queue.getReadyFiles().length===0){setStateEmpty(that)}renderUploadTotalMessage(that);updateQueueSummaryText(that)};var updateStateAfterCompletion=function(that){if(that.queue.getReadyFiles().length===0){setStateDone(that)}else{setStateLoaded(that)}updateTotalAtCompletion(that);updateQueueSummaryText(that)};var bindEvents=function(that){that.events.afterFileDialog.addListener(function(){updateStateAfterFileDialog(that)});that.events.afterFileQueued.addListener(function(file){that.queue.addFile(file)});that.events.onFileRemoved.addListener(function(file){that.removeFile(file)});that.events.afterFileRemoved.addListener(function(){updateStateAfterFileRemoval(that)});that.events.onUploadStart.addListener(function(){setStateUploading(that)});that.events.onUploadStop.addListener(function(){that.locate(that.options.focusWithEvent.onUploadStop).focus()});that.events.onFileStart.addListener(function(file){file.filestatus=fluid.uploader.fileStatusConstants.IN_PROGRESS;that.queue.startFile()});that.events.onFileProgress.addListener(function(file,currentBytes,totalBytes){that.queue.updateBatchStatus(currentBytes);updateTotalProgress(that)});that.events.onFileComplete.addListener(function(file){that.queue.finishFile(file);that.events.afterFileComplete.fire(file);if(that.queue.shouldUploadNextFile()){that.strategy.remote.uploadNextFile()}else{that.events.afterUploadComplete.fire(that.queue.currentBatch.files);that.queue.clearCurrentBatch()}});that.events.onFileSuccess.addListener(function(file){file.filestatus=fluid.uploader.fileStatusConstants.COMPLETE;if(that.queue.currentBatch.bytesUploadedForFile===0){that.queue.currentBatch.totalBytesUploaded+=file.size}updateTotalProgress(that)});that.events.onFileError.addListener(function(file,error){if(error===fluid.uploader.errorConstants.UPLOAD_STOPPED){that.queue.isUploading=false;return }file.filestatus=fluid.uploader.fileStatusConstants.ERROR;if(that.queue.isUploading){that.queue.currentBatch.totalBytesUploaded+=file.size;that.queue.currentBatch.numFilesErrored++}});that.events.afterUploadComplete.addListener(function(){that.queue.isUploading=false;updateStateAfterCompletion(that)})};var setupUploader=function(that){if(that.options.demo){that.demo=fluid.typeTag("fluid.uploader.demo")}fluid.initDependents(that);disableElement(that,that.locate("uploadButton"));bindDOMEvents(that);bindEvents(that);updateQueueSummaryText(that);that.statusUpdater();that.container.attr("role","application")};fluid.uploader=function(container,options){var that=fluid.typeTag("fluid.uploader");if(fluid.progressiveChecker){fluid.staticEnvironment.uploaderContext=fluid.invoke("fluid.progressiveChecker",null,that)}return fluid.invoke("fluid.uploader.impl",[container,options],that)};fluid.demands("fluid.progressiveChecker","fluid.uploader",{funcName:"fluid.progressiveChecker",args:[{checks:[{feature:"{fluid.browser.supportsBinaryXHR}",contextName:"fluid.uploader.html5"},{feature:"{fluid.browser.supportsFlash}",contextName:"fluid.uploader.swfUpload"}],defaultTypeTag:fluid.typeTag("fluid.uploader.singleFile")}]});fluid.progressiveEnhanceableUploader=function(container,enhanceable,options){return fluid.uploader(container,options)};fluid.uploader.multiFileUploader=function(container,options){var that=fluid.initView("fluid.uploader.multiFileUploader",container,options);that.queue=fluid.uploader.fileQueue();that.browse=function(){if(!that.queue.isUploading){that.strategy.local.browse()}};that.removeFile=function(file){that.queue.removeFile(file);that.strategy.local.removeFile(file);that.events.afterFileRemoved.fire(file)};that.start=function(){that.queue.start();that.events.onUploadStart.fire(that.queue.currentBatch.files);that.strategy.remote.uploadNextFile()};that.stop=function(){that.events.onUploadStop.fire();that.strategy.remote.stop()};setupUploader(that);return that};fluid.defaults("fluid.uploader.multiFileUploader",{components:{strategy:{type:"fluid.uploader.progressiveStrategy"},fileQueueView:{type:"fluid.uploader.fileQueueView",options:{model:"{multiFileUploader}.queue.files",uploaderContainer:"{multiFileUploader}.container",events:"{multiFileUploader}.events"}},totalProgress:{type:"fluid.uploader.totalProgressBar",options:{selectors:{progressBar:".flc-uploader-queue-footer",displayElement:".flc-uploader-total-progress",label:".flc-uploader-total-progress-text",indicator:".flc-uploader-total-progress",ariaElement:".flc-uploader-total-progress"}}}},invokers:{statusUpdater:"fluid.uploader.ariaLiveRegionUpdater"},queueSettings:{uploadURL:"",postParams:{},fileSizeLimit:"20480",fileTypes:"*",fileTypesDescription:null,fileUploadLimit:0,fileQueueLimit:0},demo:false,selectors:{fileQueue:".flc-uploader-queue",browseButton:".flc-uploader-button-browse",browseButtonText:".flc-uploader-button-browse-text",uploadButton:".flc-uploader-button-upload",pauseButton:".flc-uploader-button-pause",totalFileStatusText:".flc-uploader-total-progress-text",instructions:".flc-uploader-browse-instructions",statusRegion:".flc-uploader-status-region"},focusWithEvent:{afterFileDialog:"uploadButton",afterUploadStart:"pauseButton",onUploadStop:"uploadButton"},styles:{disabled:"fl-uploader-disabled",hidden:"fl-uploader-hidden",dim:"fl-uploader-dim",totalProgress:"fl-uploader-total-progress-okay",totalProgressError:"fl-uploader-total-progress-errored",browseButton:"fl-uploader-browseMore"},events:{afterReady:null,onFileDialog:null,afterFileQueued:null,onFileRemoved:null,afterFileRemoved:null,onQueueError:null,afterFileDialog:null,onUploadStart:null,onUploadStop:null,onFileStart:null,onFileProgress:null,onFileError:null,onFileSuccess:null,onFileComplete:null,afterFileComplete:null,afterUploadComplete:null},strings:{progress:{toUploadLabel:"To upload: %fileCount %fileLabel (%totalBytes)",totalProgressLabel:"Uploading: %curFileN of %totalFilesN %fileLabel (%currBytes of %totalBytes)",completedLabel:"Uploaded: %curFileN of %totalFilesN %fileLabel (%totalCurrBytes)%errorString",numberOfErrors:", %errorsN %errorLabel",singleFile:"file",pluralFiles:"files",singleError:"error",pluralErrors:"errors"},buttons:{browse:"Browse Files",addMore:"Add More",stopUpload:"Stop Upload",cancelRemaning:"Cancel remaining Uploads",resumeUpload:"Resume Upload"},queue:{emptyQueue:"File list: No files waiting to be uploaded.",queueSummary:"File list:  %totalUploaded files uploaded, %totalInUploadQueue file waiting to be uploaded."}},mergePolicy:{model:"preserve"}});fluid.demands("fluid.uploader.impl","fluid.uploader",{funcName:"fluid.uploader.multiFileUploader"});fluid.demands("fluid.uploader.totalProgressBar","fluid.uploader.multiFileUploader",{funcName:"fluid.progress",args:["{multiFileUploader}.container",fluid.COMPONENT_OPTIONS]});fluid.uploader.formatFileSize=function(bytes){if(typeof (bytes)==="number"){if(bytes===0){return"0.0 KB"}else{if(bytes>0){if(bytes<1048576){return(Math.ceil(bytes/1024*10)/10).toFixed(1)+" KB"}else{return(Math.ceil(bytes/1048576*10)/10).toFixed(1)+" MB"}}}}return""};fluid.uploader.derivePercent=function(num,total){return Math.round((num*100)/total)};fluid.uploader.ariaLiveRegionUpdater=function(statusRegion,totalFileStatusText,events){statusRegion.attr("role","log");statusRegion.attr("aria-live","assertive");statusRegion.attr("aria-relevant","text");statusRegion.attr("aria-atomic","true");var regionUpdater=function(){statusRegion.text(totalFileStatusText.text())};events.afterFileDialog.addListener(regionUpdater);events.afterFileRemoved.addListener(regionUpdater);events.afterUploadComplete.addListener(regionUpdater)};fluid.demands("fluid.uploader.ariaLiveRegionUpdater","fluid.uploader.multiFileUploader",{funcName:"fluid.uploader.ariaLiveRegionUpdater",args:["{multiFileUploader}.dom.statusRegion","{multiFileUploader}.dom.totalFileStatusText","{multiFileUploader}.events"]});fluid.uploader.errorConstants={HTTP_ERROR:-200,MISSING_UPLOAD_URL:-210,IO_ERROR:-220,SECURITY_ERROR:-230,UPLOAD_LIMIT_EXCEEDED:-240,UPLOAD_FAILED:-250,SPECIFIED_FILE_ID_NOT_FOUND:-260,FILE_VALIDATION_FAILED:-270,FILE_CANCELLED:-280,UPLOAD_STOPPED:-290};fluid.uploader.fileStatusConstants={QUEUED:-1,IN_PROGRESS:-2,ERROR:-3,COMPLETE:-4,CANCELLED:-5};var toggleVisibility=function(toShow,toHide){if(window.opera){toShow.show().removeClass("hideUploaderForOpera");toHide.show().addClass("hideUploaderForOpera")}else{toShow.show();toHide.hide()}};var determineContainer=function(options){var defaults=fluid.defaults("fluid.uploader.singleFileStrategy");return(options&&options.container)?options.container:defaults.container};fluid.uploader.singleFileUploader=function(container,options){var that=fluid.initView("fluid.uploader.singleFileUploader",container,options);toggleVisibility($(that.options.selectors.basicUpload),that.container);return that};fluid.defaults("fluid.uploader.singleFileUploader",{selectors:{basicUpload:".fl-progEnhance-basic"}});fluid.demands("fluid.uploader.impl",["fluid.uploader","fluid.uploader.singleFile"],{funcName:"fluid.uploader.singleFileUploader"})})(jQuery,fluid_1_3);